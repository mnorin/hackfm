#!/bin/bash
# dialog.class - MC-style dialog boxes using ba.sh

# Note: TUI components should be loaded by the main application before using dialog

__DIALOG___properties=()

__DIALOG__.property(){
    # Property indices
    local title=0
    local message=1
    local input_value=2
    local result=3
    
    if [ "$2" = "=" ]; then
        __DIALOG___properties[$1]="$3"
    else
        echo "${__DIALOG___properties[$1]}"
    fi
}

# Property accessors
__DIALOG__.title(){
    if [ "$1" = "=" ]; then
        __DIALOG__.property title = "$2"
    else
        __DIALOG__.property title
    fi
}

__DIALOG__.message(){
    if [ "$1" = "=" ]; then
        __DIALOG__.property message = "$2"
    else
        __DIALOG__.property message
    fi
}

__DIALOG__.input_value(){
    if [ "$1" = "=" ]; then
        __DIALOG__.property input_value = "$2"
    else
        __DIALOG__.property input_value
    fi
}

__DIALOG__.result(){
    if [ "$1" = "=" ]; then
        __DIALOG__.property result = "$2"
    else
        __DIALOG__.property result
    fi
}

# Show input dialog - returns 0 if OK, 1 if Cancel
# Usage: dialog.show_input "Title" "Message" "default_value"
# Result in dialog.input_value
__DIALOG__.show_input(){
    local title="$1"
    local message="$2"
    local default="${3:-}"
    
    __DIALOG__.title = "$title"
    __DIALOG__.message = "$message"
    __DIALOG__.input_value = "$default"
    
    # Get terminal size
    local size=$(tui.screen.size)
    local rows=${size% *}
    local cols=${size#* }
    
    # Calculate dialog dimensions
    local dialog_width=60
    local dialog_height=7
    local dialog_row=$(( (rows - dialog_height) / 2 ))
    local dialog_col=$(( (cols - dialog_width) / 2 ))
    
    # Draw dialog background (shadow effect)
    tui.color.bg_black
    for ((r=dialog_row+1; r<dialog_row+dialog_height+1; r++)); do
        tui.cursor.move $r $((dialog_col + 2))
        printf "%$((dialog_width))s" ""
    done
    tui.color.reset
    
    # Draw dialog box with beige/tan background
    tui.color.bg_white
    tui.color.black
    for ((r=dialog_row; r<dialog_row+dialog_height; r++)); do
        tui.cursor.move $r $dialog_col
        printf "%${dialog_width}s" ""
    done
    
    # Draw border
    tui.cursor.move $dialog_row $dialog_col
    tui.color.bg_white
    tui.color.black
    tui.box.draw $dialog_row $dialog_col $dialog_width $dialog_height
    
    # Draw title
    tui.cursor.move $dialog_row $((dialog_col + 2))
    tui.color.bg_white
    tui.color.black
    tui.color.bold
    printf " %s " "$title"
    tui.color.reset
    
    # Draw message
    tui.cursor.move $((dialog_row + 2)) $((dialog_col + 2))
    tui.color.bg_white
    tui.color.black
    printf "%-$((dialog_width - 4))s" "$message"
    
    # Draw input field (cyan background)
    tui.cursor.move $((dialog_row + 3)) $((dialog_col + 2))
    tui.color.bg_cyan
    tui.color.black
    local input="$(__DIALOG__.input_value)"
    printf "%-$((dialog_width - 4))s" "$input"
    
    # Draw buttons
    tui.cursor.move $((dialog_row + 5)) $((dialog_col + dialog_width/2 - 10))
    tui.color.bg_white
    tui.color.black
    tui.color.bold
    printf "[ OK ]"
    tui.color.reset
    tui.color.bg_white
    tui.color.black
    printf "     "
    tui.color.bold
    printf "[Cancel]"
    tui.color.reset
    
    # Input loop
    local cursor_pos=${#input}
    local focus=0  # 0=input field, 1=OK button, 2=Cancel button
    
    # Show cursor
    tui.cursor.show
    
    while true; do
        # Redraw buttons based on focus
        tui.cursor.move $((dialog_row + 5)) $((dialog_col + dialog_width/2 - 10))
        if [ $focus -eq 1 ]; then
            tui.color.bg_cyan
            tui.color.black
            tui.color.bold
        else
            tui.color.bg_white
            tui.color.black
            tui.color.bold
        fi
        printf "[ OK ]"
        tui.color.reset
        
        tui.color.bg_white
        tui.color.black
        printf "     "
        
        if [ $focus -eq 2 ]; then
            tui.color.bg_cyan
            tui.color.black
            tui.color.bold
        else
            tui.color.bg_white
            tui.color.black
            tui.color.bold
        fi
        printf "[Cancel]"
        tui.color.reset
        
        # Position cursor
        if [ $focus -eq 0 ]; then
            # Cursor in input field
            tui.cursor.move $((dialog_row + 3)) $((dialog_col + 2 + cursor_pos))
        else
            # Hide cursor when on buttons
            tui.cursor.hide
        fi
        
        local key=$(tui.input.key)
        
        case "$key" in
            ENTER)
                tui.cursor.hide
                if [ $focus -eq 0 ] || [ $focus -eq 1 ]; then
                    # OK
                    __DIALOG__.result = 0
                    return 0
                else
                    # Cancel
                    __DIALOG__.result = 1
                    return 1
                fi
                ;;
            ESC)
                tui.cursor.hide
                __DIALOG__.result = 1
                return 1
                ;;
            TAB)
                # Cycle focus: input -> OK -> Cancel -> input
                focus=$(( (focus + 1) % 3 ))
                if [ $focus -eq 0 ]; then
                    tui.cursor.show
                fi
                ;;
            BACKSPACE)
                if [ $focus -eq 0 ] && [ $cursor_pos -gt 0 ]; then
                    input="${input:0:$((cursor_pos-1))}${input:$cursor_pos}"
                    cursor_pos=$((cursor_pos - 1))
                    __DIALOG__.input_value = "$input"
                    
                    # Redraw input field
                    tui.cursor.move $((dialog_row + 3)) $((dialog_col + 2))
                    tui.color.bg_cyan
                    tui.color.black
                    printf "%-$((dialog_width - 4))s" "$input"
                fi
                ;;
            LEFT)
                if [ $focus -eq 0 ] && [ $cursor_pos -gt 0 ]; then
                    cursor_pos=$((cursor_pos - 1))
                fi
                ;;
            RIGHT)
                if [ $focus -eq 0 ] && [ $cursor_pos -lt ${#input} ]; then
                    cursor_pos=$((cursor_pos + 1))
                fi
                ;;
            HOME)
                if [ $focus -eq 0 ]; then
                    cursor_pos=0
                fi
                ;;
            END)
                if [ $focus -eq 0 ]; then
                    cursor_pos=${#input}
                fi
                ;;
            DELETE)
                if [ $focus -eq 0 ] && [ $cursor_pos -lt ${#input} ]; then
                    input="${input:0:$cursor_pos}${input:$((cursor_pos+1))}"
                    __DIALOG__.input_value = "$input"
                    
                    # Redraw input field
                    tui.cursor.move $((dialog_row + 3)) $((dialog_col + 2))
                    tui.color.bg_cyan
                    tui.color.black
                    printf "%-$((dialog_width - 4))s" "$input"
                fi
                ;;
            *)
                # Regular character input - only in input field
                if [ $focus -eq 0 ] && [ ${#key} -eq 1 ]; then
                    input="${input:0:$cursor_pos}${key}${input:$cursor_pos}"
                    cursor_pos=$((cursor_pos + 1))
                    __DIALOG__.input_value = "$input"
                    
                    # Redraw input field
                    tui.cursor.move $((dialog_row + 3)) $((dialog_col + 2))
                    tui.color.bg_cyan
                    tui.color.black
                    printf "%-$((dialog_width - 4))s" "$input"
                fi
                ;;
        esac
    done
}

# Show confirmation dialog - returns 0 if Yes, 1 if No
# Usage: dialog.show_confirm "Title" "Question?"
__DIALOG__.show_confirm(){
    local title="$1"
    local message="$2"
    
    __DIALOG__.title = "$title"
    __DIALOG__.message = "$message"
    
    # Get terminal size
    local size=$(tui.screen.size)
    local rows=${size% *}
    local cols=${size#* }
    
    # Calculate dialog dimensions
    local dialog_width=50
    local dialog_height=6
    local dialog_row=$(( (rows - dialog_height) / 2 ))
    local dialog_col=$(( (cols - dialog_width) / 2 ))
    
    # Draw dialog background (shadow effect)
    tui.color.bg_black
    for ((r=dialog_row+1; r<dialog_row+dialog_height+1; r++)); do
        tui.cursor.move $r $((dialog_col + 2))
        printf "%$((dialog_width))s" ""
    done
    tui.color.reset
    
    # Draw dialog box
    tui.color.bg_white
    tui.color.black
    for ((r=dialog_row; r<dialog_row+dialog_height; r++)); do
        tui.cursor.move $r $dialog_col
        printf "%${dialog_width}s" ""
    done
    
    # Draw border
    tui.cursor.move $dialog_row $dialog_col
    tui.color.bg_white
    tui.color.black
    tui.box.draw $dialog_row $dialog_col $dialog_width $dialog_height
    
    # Draw title
    tui.cursor.move $dialog_row $((dialog_col + 2))
    tui.color.bg_white
    tui.color.black
    tui.color.bold
    printf " %s " "$title"
    tui.color.reset
    
    # Draw message (centered)
    tui.cursor.move $((dialog_row + 2)) $((dialog_col + 2))
    tui.color.bg_white
    tui.color.black
    local msg_len=${#message}
    local padding=$(( (dialog_width - 4 - msg_len) / 2 ))
    printf "%${padding}s%s" "" "$message"
    
    # Draw buttons
    local selected=0  # 0=Yes, 1=No
    
    while true; do
        tui.cursor.move $((dialog_row + 4)) $((dialog_col + dialog_width/2 - 8))
        
        if [ $selected -eq 0 ]; then
            tui.color.bg_cyan
            tui.color.black
            tui.color.bold
        else
            tui.color.bg_white
            tui.color.black
        fi
        printf "[ Yes ]"
        tui.color.reset
        
        tui.color.bg_white
        tui.color.black
        printf "   "
        
        if [ $selected -eq 1 ]; then
            tui.color.bg_cyan
            tui.color.black
            tui.color.bold
        else
            tui.color.bg_white
            tui.color.black
        fi
        printf "[ No ]"
        tui.color.reset
        
        local key=$(tui.input.key)
        
        case "$key" in
            ENTER)
                if [ $selected -eq 0 ]; then
                    __DIALOG__.result = 0
                    return 0
                else
                    __DIALOG__.result = 1
                    return 1
                fi
                ;;
            LEFT|RIGHT|TAB)
                selected=$((1 - selected))
                ;;
            y|Y)
                __DIALOG__.result = 0
                return 0
                ;;
            n|N)
                __DIALOG__.result = 1
                return 1
                ;;
            ESC)
                __DIALOG__.result = 2
                return 2
                ;;
        esac
    done
}

# Show message dialog - press any key to close
# Usage: dialog.show_status "Title" "Message text"
# Like show_message but returns immediately - use to show progress/status while work is happening
__DIALOG__.show_status(){
    local title="$1"
    local message="$2"

    local size=$(tui.screen.size)
    local rows=${size% *}
    local cols=${size#* }

    local dialog_width=50
    [ ${#message} -gt 44 ] && dialog_width=$(( ${#message} + 6 ))
    [ $dialog_width -gt $((cols - 4)) ] && dialog_width=$((cols - 4))
    local dialog_height=5
    local dialog_row=$(( (rows - dialog_height) / 2 ))
    local dialog_col=$(( (cols - dialog_width) / 2 ))

    # Shadow
    tui.color.bg_black
    for ((r=dialog_row+1; r<dialog_row+dialog_height+1; r++)); do
        tui.cursor.move $r $((dialog_col + 2))
        printf "%$((dialog_width))s" ""
    done
    tui.color.reset

    # Box background
    tui.color.bg_white
    tui.color.black
    for ((r=dialog_row; r<dialog_row+dialog_height; r++)); do
        tui.cursor.move $r $dialog_col
        printf "%${dialog_width}s" ""
    done

    tui.box.draw $dialog_row $dialog_col $dialog_width $dialog_height

    # Title
    tui.cursor.move $dialog_row $((dialog_col + 2))
    tui.color.bg_white
    tui.color.black
    tui.color.bold
    printf " %s " "$title"
    tui.color.reset

    # Message centered
    tui.cursor.move $((dialog_row + 2)) $((dialog_col + 2))
    tui.color.bg_white
    tui.color.black
    local msg_len=${#message}
    local padding=$(( (dialog_width - 4 - msg_len) / 2 ))
    [ $padding -lt 0 ] && padding=0
    printf "%${padding}s%s" "" "$message"
    tui.color.reset
    # No key wait - returns immediately
}

# Usage: dialog.show_message "Title" "Message text"
__DIALOG__.show_message(){
    local title="$1"
    local message="$2"
    
    __DIALOG__.title = "$title"
    __DIALOG__.message = "$message"
    
    # Get terminal size
    local size=$(tui.screen.size)
    local rows=${size% *}
    local cols=${size#* }
    
    # Calculate dialog dimensions
    local dialog_width=50
    local dialog_height=6
    local dialog_row=$(( (rows - dialog_height) / 2 ))
    local dialog_col=$(( (cols - dialog_width) / 2 ))
    
    # Draw dialog background (shadow effect)
    tui.color.bg_black
    for ((r=dialog_row+1; r<dialog_row+dialog_height+1; r++)); do
        tui.cursor.move $r $((dialog_col + 2))
        printf "%$((dialog_width))s" ""
    done
    tui.color.reset
    
    # Draw dialog box
    tui.color.bg_white
    tui.color.black
    for ((r=dialog_row; r<dialog_row+dialog_height; r++)); do
        tui.cursor.move $r $dialog_col
        printf "%${dialog_width}s" ""
    done
    
    # Draw border
    tui.color.bg_white
    tui.color.black
    tui.box.draw $dialog_row $dialog_col $dialog_width $dialog_height
    
    # Draw title
    tui.cursor.move $dialog_row $((dialog_col + 2))
    tui.color.bg_white
    tui.color.black
    tui.color.bold
    printf " %s " "$title"
    tui.color.reset
    
    # Draw message (centered)
    tui.cursor.move $((dialog_row + 2)) $((dialog_col + 2))
    tui.color.bg_white
    tui.color.black
    local msg_len=${#message}
    local padding=$(( (dialog_width - 4 - msg_len) / 2 ))
    printf "%${padding}s%s" "" "$message"
    
    # Draw OK button (cyan for selected/active)
    tui.cursor.move $((dialog_row + 4)) $((dialog_col + dialog_width/2 - 3))
    tui.color.bg_cyan
    tui.color.black
    tui.color.bold
    printf "[ OK ]"
    tui.color.reset
    
    # Wait for key
    tui.input.key >/dev/null
    
    __DIALOG__.result = 0
    return 0
}
